<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fluxo de Caixa - Dashboard</title>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #0f172a;
        color: #e5e7eb;
    }

    header {
        background: #1e293b;
        padding: 20px;
        text-align: center;
        font-size: 26px;
        font-weight: bold;
        color: #f97316;
        box-shadow: 0 0 15px #f9731633;
    }

    .container {
        max-width: 1200px;
        margin: auto;
        padding: 20px;
    }

    .cards {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 30px;
    }

    .card {
        background: #1e293b;
        padding: 20px;
        border-radius: 10px;
        flex: 1;
        min-width: 240px;
        text-align: center;
        box-shadow: 0 0 12px #00000055;
    }

    .card h2 {
        margin: 0;
        font-size: 18px;
        color: #f97316;
    }

    .card p {
        margin: 10px 0 0 0;
        font-size: 22px;
        font-weight: bold;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 40px;
    }

    table th {
        background: #f97316;
        padding: 10px;
        text-align: left;
        font-size: 14px;
    }

    table td {
        padding: 10px;
        border-bottom: 1px solid #334155;
        font-size: 14px;
    }

    td.text-right {
        text-align: right;
    }

    .abas {
        display: flex;
        justify-content: center;
        margin: 20px 0;
        gap: 20px;
    }

    .abas button {
        padding: 10px 20px;
        border: none;
        background: #1e293b;
        color: #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
        font-size: 15px;
    }

    .abas button.active {
        background: #f97316;
        color: #000;
    }

    .graficos, .tabelas {
        display: none;
    }

    .graficos.active, .tabelas.active {
        display: block;
    }

    canvas {
        background: #1e293b;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 40px;
        box-shadow: 0 0 12px #00000055;
    }

</style>
</head>
<body>

<header>Fluxo de Caixa • Dashboard Online</header>

<div class="container">

    <div class="cards">
        <div class="card">
            <h2>Total Recebimentos</h2>
            <p id="cardReceber">R$ 0,00</p>
        </div>
        <div class="card">
            <h2>Total Pagamentos</h2>
            <p id="cardPagar">R$ 0,00</p>
        </div>
        <div class="card">
            <h2>Comprometimento</h2>
            <p id="cardComprometimento">0%</p>
        </div>
    </div>

    <div class="abas">
        <button id="btnViewTabela" class="active">Tabelas</button>
        <button id="btnViewGraficos">Gráficos</button>
    </div>

    <div id="tabTabelas" class="tabelas active">

        <h2>Recebimentos</h2>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Descrição</th>
                    <th class="text-right">Valor</th>
                </tr>
            </thead>
            <tbody id="tbodyRecebimentos"></tbody>
        </table>

        <h2>Pagamentos</h2>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Descrição</th>
                    <th class="text-right">Valor</th>
                </tr>
            </thead>
            <tbody id="tbodyPagamentos"></tbody>
        </table>

        <h2>Resumo Diário</h2>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th class="text-right">Receb.</th>
                    <th class="text-right">Pag.</th>
                    <th class="text-right">Saldo</th>
                </tr>
            </thead>
            <tbody id="tbodyResumo"></tbody>
        </table>
    </div>

    <div id="tabGraficos" class="graficos">

        <canvas id="chartSaldo"></canvas>
        <canvas id="chartRecebPag"></canvas>
        <canvas id="chartCategorias"></canvas>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

// URLs do Google Sheets com PROXY CORS
const URL_PAGAMENTOS =
  "https://cors.isomorphic-git.org/https://docs.google.com/spreadsheets/d/1hJ152Y0470mr-IWjtgiVBC5hIxNCT6WhSgu4qZ4DONc/export?format=csv&gid=0";

const URL_RECEBIMENTOS =
  "https://cors.isomorphic-git.org/https://docs.google.com/spreadsheets/d/1hJ152Y0470mr-IWjtgiVBC5hIxNCT6WhSgu4qZ4DONc/export?format=csv&gid=1132401737";

let recebimentos = [];
let pagamentos = [];

// --- Funções utilitárias ---
const formatCurrency = v =>
  v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

const formatDateBr = (iso) => {
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    return d.toLocaleDateString("pt-BR");
};

// --- Detectar delimitador ---
function detectarDelimitador(headerLine) {
    const c = (headerLine.match(/,/g) || []).length;
    const s = (headerLine.match(/;/g) || []).length;
    return s > c ? ";" : ",";
}

// --- Parse simples de CSV ---
function parseLinhaCSV(line, delimiter) {
    const result = [];
    let atual = "";
    let emAspas = false;

    for (let i = 0; i < line.length; i++) {
        const ch = line[i];

        if (ch === '"') {
            if (emAspas && line[i + 1] === '"') {
                atual += '"';
                i++;
            } else {
                emAspas = !emAspas;
            }
        } else if (ch === delimiter && !emAspas) {
            result.push(atual);
            atual = "";
        } else {
            atual += ch;
        }
    }
    result.push(atual);
    return result;
}

function parseCSV(csv) {
    const linhas = csv.split(/\r?\n/).filter(l => l.trim().length > 0);
    if (linhas.length === 0) return [];

    const delimiter = detectarDelimitador(linhas[0]);
    return linhas.map(l => parseLinhaCSV(l, delimiter));
}

// --- Localizar coluna ---
function encontrarIndice(header, palavras) {
    return header.findIndex(h => palavras.some(p => h.includes(p)));
}

// --- Parser de RECEBIMENTOS ---
function parseRecebimentos(csv) {
    const rows = parseCSV(csv);
    if (rows.length < 2) return [];

    const header = rows[0].map(h => h.trim().toUpperCase());

    const idxData  = encontrarIndice(header, ["DATA"]);
    const idxDesc  = encontrarIndice(header, ["RECEB", "DESC"]);
    const idxValor = encontrarIndice(header, ["VALOR"]);

    if (idxData === -1 || idxDesc === -1 || idxValor === -1) return [];

    const out = [];

    for (let i = 1; i < rows.length; i++) {
        const cols = rows[i];
        if (!cols[idxData] || !cols[idxValor]) continue;

        const dataBr = cols[idxData].trim();
        const desc   = cols[idxDesc] ? cols[idxDesc].trim() : "";
        let valorStr = cols[idxValor].trim();

        valorStr = valorStr.replace(/\./g, "").replace(",", ".");
        const valor = parseFloat(valorStr);
        if (isNaN(valor)) continue;

        let dataIso = dataBr;
        if (dataBr.includes("/")) {
            const [dia, mes, ano] = dataBr.split("/");
            dataIso = `${ano}-${mes}-${dia}`;
        }

        out.push({ data: dataIso, descricao: desc, valor });
    }

    return out;
}

// --- Parser de PAGAMENTOS ---
function parsePagamentos(csv) {
    const rows = parseCSV(csv);
    if (rows.length < 2) return [];

    const header = rows[0].map(h => h.trim().toUpperCase());

    const idxData  = encontrarIndice(header, ["DATA"]);
    const idxDesc  = encontrarIndice(header, ["PAGAR", "DESC"]);
    const idxValor = encontrarIndice(header, ["VALOR"]);

    if (idxData === -1 || idxDesc === -1 || idxValor === -1) return [];

    const out = [];

    for (let i = 1; i < rows.length; i++) {
        const cols = rows[i];
        if (!cols[idxData] || !cols[idxValor]) continue;

        const dataBr = cols[idxData].trim();
        const desc   = cols[idxDesc] ? cols[idxDesc].trim() : "";
        let valorStr = cols[idxValor].trim();

        valorStr = valorStr.replace(/\./g, "").replace(",", ".");
        const valor = parseFloat(valorStr);
        if (isNaN(valor)) continue;

        let dataIso = dataBr;
        if (dataBr.includes("/")) {
            const [dia, mes, ano] = dataBr.split("/");
            dataIso = `${ano}-${mes}-${dia}`;
        }

        out.push({ data: dataIso, descricao: desc, valor });
    }

    return out;
}

// --- Preencher tabelas ---
function preencherTabelas() {
    const tbodyR = document.getElementById("tbodyRecebimentos");
    const tbodyP = document.getElementById("tbodyPagamentos");
    const tbodyRes = document.getElementById("tbodyResumo");

    tbodyR.innerHTML = "";
    tbodyP.innerHTML = "";
    tbodyRes.innerHTML = "";

    recebimentos.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${formatDateBr(r.data)}</td>
            <td>${r.descricao}</td>
            <td class="text-right">${formatCurrency(r.valor)}</td>
        `;
        tbodyR.appendChild(tr);
    });

    pagamentos.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${formatDateBr(p.data)}</td>
            <td>${p.descricao}</td>
            <td class="text-right">${formatCurrency(p.valor)}</td>
        `;
        tbodyP.appendChild(tr);
    });

    const resumo = agruparResumoDiario();
    resumo.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${formatDateBr(item.data)}</td>
            <td class="text-right">${formatCurrency(item.receb)}</td>
            <td class="text-right">${formatCurrency(item.pag)}</td>
            <td class="text-right">${formatCurrency(item.saldo)}</td>
        `;
        tbodyRes.appendChild(tr);
    });
}

// --- Resumo diário ---
function agruparResumoDiario() {
    const mapa = {};

    recebimentos.forEach(r => {
        mapa[r.data] = mapa[r.data] || { data: r.data, receb: 0, pag: 0 };
        mapa[r.data].receb += r.valor;
    });

    pagamentos.forEach(p => {
        mapa[p.data] = mapa[p.data] || { data: p.data, receb: 0, pag: 0 };
        mapa[p.data].pag += p.valor;
    });

    const arr = Object.values(mapa).sort((a, b) => a.data.localeCompare(b.data));

    let saldo = 0;
    arr.forEach(item => {
        saldo += item.receb - item.pag;
        item.saldo = saldo;
    });

    return arr;
}

// --- Atualizar cards ---
function atualizarCards() {
    const totalReceber = recebimentos.reduce((s, r) => s + r.valor, 0);
    const totalPagar    = pagamentos.reduce((s, p) => s + p.valor, 0);

    document.getElementById("cardReceber").textContent = formatCurrency(totalReceber);
    document.getElementById("cardPagar").textContent = formatCurrency(totalPagar);
    document.getElementById("cardComprometimento").textContent =
      totalReceber > 0 ? ((totalPagar / totalReceber) * 100).toFixed(2) + "%" : "0%";
}

// --- Gráficos ---
let chartSaldo, chartRecebPag, chartCategorias;

function destruirGraficos() {
    if (chartSaldo) chartSaldo.destroy();
    if (chartRecebPag) chartRecebPag.destroy();
    if (chartCategorias) chartCategorias.destroy();
}

function criarGraficos() {
    destruirGraficos();

    const resumo = agruparResumoDiario();
    const labels = resumo.map(r => formatDateBr(r.data));

    // Saldo acumulado
    chartSaldo = new Chart(document.getElementById("chartSaldo"), {
        type: "line",
        data: {
            labels,
            datasets: [
                {
                    label: "Saldo acumulado",
                    data: resumo.map(r => r.saldo),
                    borderWidth: 2,
                    tension: 0.3
                }
            ]
        }
    });

    // Recebimentos vs Pagamentos
    chartRecebPag = new Chart(document.getElementById("chartRecebPag"), {
        type: "bar",
        data: {
            labels,
            datasets: [
                {
                    label: "Recebimentos",
                    data: resumo.map(r => r.receb),
                    borderWidth: 1
                },
                {
                    label: "Pagamentos",
                    data: resumo.map(r => r.pag),
                    borderWidth: 1
                }
            ]
        }
    });

    // Categorias pagas
    const categorias = {};
    pagamentos.forEach(p => {
        categorias[p.descricao] = (categorias[p.descricao] || 0) + p.valor;
    });

    chartCategorias = new Chart(document.getElementById("chartCategorias"), {
        type: "doughnut",
        data: {
            labels: Object.keys(categorias),
            datasets: [
                {
                    data: Object.values(categorias),
                    borderWidth: 1
                }
            ]
        }
    });
}

// --- Abas ---
document.getElementById("btnViewTabela").addEventListener("click", () => {
    document.getElementById("tabTabelas").classList.add("active");
    document.getElementById("tabGraficos").classList.remove("active");

    document.getElementById("btnViewTabela").classList.add("active");
    document.getElementById("btnViewGraficos").classList.remove("active");
});

document.getElementById("btnViewGraficos").addEventListener("click", () => {
    document.getElementById("tabGraficos").classList.add("active");
    document.getElementById("tabTabelas").classList.remove("active");

    document.getElementById("btnViewGraficos").classList.add("active");
    document.getElementById("btnViewTabela").classList.remove("active");

    criarGraficos();
});

// --- Carregar dados ---
async function carregarDados() {
    try {
        const [csvRec, csvPag] = await Promise.all([
            fetch(URL_RECEBIMENTOS).then(r => r.text()),
            fetch(URL_PAGAMENTOS).then(r => r.text())
        ]);

        recebimentos = parseRecebimentos(csvRec);
        pagamentos   = parsePagamentos(csvPag);

        preencherTabelas();
        atualizarCards();

    } catch (err) {
        console.error("Erro ao buscar dados:", err);
    }
}

document.addEventListener("DOMContentLoaded", carregarDados);

</script>

</body>
</html>
